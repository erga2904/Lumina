<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina V40 | Studio</title>
    
    <!-- FONTS & ICON -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            /* COLOR SCHEME: Pastel Dream */
            --bg-grad: linear-gradient(135deg, #fddbb7 0%, #f7ebd9 50%, #dcfce7 100%);
            --txt-prim: #1f1f1f; --txt-sec: #6b7280;
            --card-bg: #ffffff;
            --nav-bg: rgba(253, 252, 246, 0.75); 
            --glass-blur: blur(25px);
            --acc-btn: #f5f5f4; --acc-active: #18181b; 
            --start-btn: #ffe4cc; --start-txt: #9c4221;
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            --txt-prim: #ffffff; --txt-sec: #a1a1aa;
            --card-bg: #121212; --nav-bg: rgba(24, 24, 27, 0.8);
            --acc-btn: #27272a; --acc-active: #38bdf8;
            --start-btn: #3f3f46; --start-txt: #fff;
        }

        /* PERFORMANCE MODE */
        [data-perf="fast"] { --glass-blur: none; --nav-bg: var(--card-bg); }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
        
        body {
            background: var(--bg-grad); background-attachment: fixed; color: var(--txt-prim);
            font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; padding-bottom: 120px;
            transition: background 0.3s;
        }

        /* --- 1. NAVBAR --- */
        nav {
            margin-top: 30px; background: var(--nav-bg); backdrop-filter: var(--glass-blur);
            padding: 8px 12px 8px 25px; border-radius: 50px;
            display: flex; gap: 40px; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.4);
            z-index: 100; min-width: 380px; max-width: 90%;
        }
        
        /* LOGO & HOME */
        .nav-brand { 
            font-weight: 800; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; color: var(--txt-prim);
        }
        .nav-brand:hover { opacity: 0.6; }

        /* NAV LINKS */
        .nav-mid { display:flex; gap:20px; font-weight:600; font-size:0.9rem; color:var(--txt-sec); }
        .nav-link { cursor:pointer; transition:0.2s; }
        .nav-link.active, .nav-link:hover { color:var(--txt-prim); }

        /* USER AREA */
        .nav-user { display: flex; gap: 10px; align-items: center; }
        
        .btn-auth {
            background: #000; color: #fff; padding: 8px 20px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 700; cursor: pointer; border: none; transition: 0.2s;
        }
        .btn-auth:hover { transform: scale(1.05); }

        .user-pic { 
            width: 34px; height: 34px; border-radius: 50%; background: #ddd; 
            object-fit: cover; display: none; cursor: pointer; border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn-set {
            width: 36px; height: 36px; border-radius: 50%; border:none; background:transparent;
            color: var(--txt-prim); cursor: pointer; transition: 0.2s; font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-set:hover { background: rgba(0,0,0,0.05); transform: rotate(90deg); }

        /* --- 2. MAIN CARD --- */
        .hero-card {
            margin-top: 35px; background: var(--card-bg); width: 100%; max-width: 550px;
            border-radius: 40px; padding: 45px 35px; text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.05);
        }
        
        .av-wrap {
            width: 90px; height: 90px; margin: 0 auto 20px; background: var(--start-btn); color: var(--start-txt);
            border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 4px solid transparent;
        }
        .av-wrap:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.5); }
        .av-wrap.done { background: #10b981; color:#fff; }

        h1 { font-size: 1.8rem; font-weight: 800; color: var(--txt-prim); margin-bottom:5px; }
        .sub-t { font-size:0.9rem; color:var(--txt-sec); margin-bottom:20px; }

        .inp-pill { background: var(--acc-btn); border-radius: 12px; padding: 5px; display: flex; margin: 10px 0;}
        .inp-pill input { flex: 1; border: 0; background: transparent; padding: 0 15px; color: var(--txt-prim); font-weight: 600; }
        .inp-pill button { background: var(--card-bg); color: var(--txt-prim); border: 0; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* COLAB LINK RESTORED */
        .lnk-clb {
            font-size: 0.75rem; color: #a1a1aa; text-decoration: none; display: inline-block;
            border-bottom: 1px dashed #d1d5db; margin-bottom: 25px; transition: 0.2s;
        }
        .lnk-clb:hover { color: #d97757; border-color: #d97757; }

        /* --- 3. MODEL SELECTION --- */
        .sec-lbl { text-align: left; font-size: 0.7rem; font-weight: 700; color: #a1a1aa; letter-spacing: 1px; margin-bottom: 12px; margin-top: 10px;}
        .grid-mdl { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom:20px }
        
        .m-card {
            background: var(--acc-btn); border-radius: 18px; padding: 16px; text-align: left;
            display: flex; gap: 12px; align-items: center; cursor: pointer; transition: 0.2s; 
            border: 2px solid transparent;
        }
        .m-card.active { background: var(--acc-active); border-color: var(--acc-active); }
        .m-card.active * { color: #fff !important; }
        .m-card.active .ic-box { background: #fff !important; } 

        .ic-box {
            width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1rem; flex-shrink: 0; background: #ffffff; color: #333;
        }
        /* Icon original colors */
        .i-inst { color: #10b981 !important; } .i-voc { color: #ec4899 !important; } .i-fast { color: #f59e0b !important; }
        /* When Active (inside logic below) -> Color black */
        .m-card.active .i-inst, .m-card.active .i-voc, .m-card.active .i-fast { color: #000 !important; }

        .mc-tit { font-size: 0.8rem; font-weight: 700; color: var(--txt-prim); }
        .mc-sub { font-size: 0.7rem; color: var(--txt-sec); }

        .process-btn {
            width: 100%; background: var(--start-btn); color: var(--start-txt); border: 0; padding: 18px; 
            border-radius: 24px; font-size: 1rem; font-weight: 800; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .process-btn:hover { transform: translateY(-2px); filter: brightness(0.95); }

        /* --- 4. POPUPS (HISTORY & SETTINGS) --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .pop-card {
            background: var(--card-bg); width: 90%; max-width: 380px;
            border-radius: 24px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative; max-height: 80vh; overflow-y: auto;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;}}

        .pop-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px; }
        .pop-tit { font-weight:800; font-size:1.1rem; color: var(--txt-prim); }
        .cls-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--txt-sec); }

        /* HISTORY LIST ITEM */
        .h-item { 
            display:flex; justify-content:space-between; align-items:center; 
            padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.05); 
        }
        .h-info div:first-child { font-weight:700; font-size:0.9rem; color: var(--txt-prim); }
        .h-info div:last-child { font-size:0.7rem; color:var(--txt-sec); }
        .h-link { font-size:0.75rem; color:#10b981; text-decoration:none; margin-left:5px; background:rgba(16,185,129,0.1); padding:4px 8px; border-radius:5px;}

        /* SETTINGS DROPDOWN (SMALL) */
        #set-drop {
            position: absolute; top: 85px; right: calc(50% - 190px + 30px); /* Aligned near cog */
            width: 200px; background: var(--card-bg); padding: 15px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); display:none; z-index: 150;
        }
        .thm-btn {
            height: 35px; width: 100%; margin-bottom: 5px; border-radius: 8px; border:2px solid transparent; cursor: pointer;
        }
        .thm-btn.t-pas { background: linear-gradient(to right, #fddbb7, #dcfce7); }
        .thm-btn.t-drk { background: #333; }
        
        /* --- 5. PLAYER WIDGET --- */
        #w-player {
            position: fixed; bottom: 30px; width: 90%; max-width: 400px;
            background: #121212; color: #fff; padding: 15px; border-radius: 18px;
            display: none; box-shadow: 0 25px 50px rgba(0,0,0,0.6); z-index: 150;
            border: 1px solid #333;
        }
        .w-flex { display: flex; align-items: center; gap: 15px; }
        .w-art { 
            width: 50px; height: 50px; background: #222; border-radius: 10px; 
            display:flex; align-items:center; justify-content:center;
        }
        .w-meta { flex:1; overflow:hidden; }
        .w-tit { font-weight: 700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .w-sub { font-size: 0.75rem; color: #aaa; }
        
        /* Loader */
        .spinner { width:20px; height:20px; border:3px solid #555; border-top-color:#1db954; border-radius:50%; animation: spin 1s infinite linear;}
        @keyframes spin {100%{transform:rotate(360deg)}}
        
        .pl-box { max-height:0; overflow:auto; transition:0.3s; margin-top:0; }
        .pl-box.open { max-height:200px; margin-top:15px; border-top:1px solid #333; padding-top:10px; }
        
        /* HIDDEN AUDIO */
        audio { display:none }
    </style>
</head>
<body>

    <nav>
        <!-- 1. BUTTON HOME (TO PORTFOLIO) -->
        <div class="nav-brand" onclick="goPortfolio()" title="Back to Portfolio">
            <i class="fas fa-chevron-left"></i> Lumina
        </div>

        <div class="nav-mid">
            <span class="nav-link active">Studio</span>
            <span class="nav-link" onclick="openHistory()">History</span>
        </div>

        <div class="nav-user">
            <!-- Firebase User -->
            <img src="" id="u-img" class="user-pic" onclick="authLogout()">
            <button id="btn-login" class="btn-auth" onclick="authLogin()">Login</button>
            
            <button class="btn-set" onclick="toggleSet()"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <!-- DROPDOWN SETTINGS -->
    <div id="set-drop">
        <div style="font-size:0.7rem; font-weight:700; color:var(--txt-sec); margin-bottom:5px">THEME</div>
        <button class="thm-btn t-pas" onclick="thm('pastel')"></button>
        <button class="thm-btn t-drk" onclick="thm('dark')"></button>
        
        <div style="margin-top:10px; font-size:0.75rem; display:flex; justify-content:space-between">
            <span>Lite Mode</span> <input type="checkbox" onchange="perf(this)">
        </div>
    </div>

    <!-- MODAL HISTORY -->
    <div id="hist-modal" class="modal-overlay" onclick="closeHistory(event)">
        <div class="pop-card">
            <div class="pop-head">
                <span class="pop-tit">Processing History</span>
                <button class="cls-btn" onclick="openHistory(false)">&times;</button>
            </div>
            
            <div id="hist-msg" style="text-align:center; padding:15px; color:#aaa; font-size:0.8rem">
                <!-- Message injected by JS -->
            </div>
            
            <div id="hist-content">
                <!-- List Items injected here -->
            </div>
        </div>
    </div>

    <!-- MAIN UI -->
    <div class="hero-card">
        <div class="av-wrap" onclick="document.getElementById('f').click()">
            <input type="file" id="f" hidden accept="audio/*">
            <i class="fas fa-cloud-upload-alt" id="ico"></i>
        </div>
        <h1>Studio</h1>
        <div class="sub-t" id="sub">Tap icon to upload file</div>

        <div class="inp-pill">
            <input id="api" placeholder="Cloudflare Link...">
            <button onclick="con(this)">Link</button>
        </div>

        <!-- RESTORED COLAB LINK -->
        <a href="https://colab.research.google.com/drive/1tw8nJdGokvMY4gMmQ8m3hOG8j0zYK5CV#scrollTo=jswAJ-NK2Aja" target="_blank" class="lnk-clb">
            Script Backend (Colab) &nearr;
        </a>

        <!-- INSTRUMENTAL -->
        <div class="sec-lbl">BEST FOR INSTRUMENTAL</div>
        <div class="grid-mdl">
            <div class="m-card active" onclick="sel('inst_v1e_plus',this)">
                <div class="ic-box i-inst"><i class="fas fa-wave-square"></i></div>
                <div><div class="mc-tit">MelBand V1E+</div><div class="mc-sub">Best Inst</div></div>
            </div>
            <div class="m-card" onclick="sel('Resurrection-Inst',this)">
                <div class="ic-box i-inst"><i class="fas fa-star"></i></div>
                <div><div class="mc-tit">Resurrec Inst</div><div class="mc-sub">Classic</div></div>
            </div>
        </div>
        
        <!-- VOCALS -->
        <div class="sec-lbl">BEST FOR VOCALS</div>
        <div class="grid-mdl">
            <div class="m-card" onclick="sel('Resurrection-v',this)">
                <div class="ic-box i-voc"><i class="fas fa-microphone"></i></div>
                <div><div class="mc-tit">Resurrec Voc</div><div class="mc-sub">Detail Voice</div></div>
            </div>
            <div class="m-card" onclick="sel('Kim_Vocal_2',this)">
                <div class="ic-box i-fast"><i class="fas fa-bolt"></i></div>
                <div><div class="mc-tit">Kim Vocal 2</div><div class="mc-sub">Ultra Fast</div></div>
            </div>
        </div>

        <button class="process-btn" onclick="run()">START SEPARATION</button>
    </div>

    <!-- PLAYER WIDGET -->
    <div id="w-player">
        <div class="w-flex">
            <div class="w-art">
                <i class="fas fa-music" id="w-ic"></i>
                <div class="spinner" id="w-ld" style="display:none"></div>
            </div>
            <div class="w-meta">
                <div class="w-tit" id="w-mt">Ready</div>
                <div class="w-sub" id="w-sb">Waiting...</div>
            </div>
            <div style="color:#1db954; font-weight:700; font-size:0.8rem" id="w-pct"></div>
        </div>
        <div class="pl-box" id="pl"></div>
    </div>
    <audio id="core-aud"></audio>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        /* --- ⚠️ ISI KONFIGURASI DI BAWAH INI DENGAN DATA ASLI ANDA --- */
       const firebaseConfig = {
        apiKey: "AIzaSyDkSwr7n2niyN5MFzr6LMOIv-4Vpqa9LlY",
        authDomain: "studio-7547085914-216a7.firebaseapp.com",
        projectId: "studio-7547085914-216a7",
        storageBucket: "studio-7547085914-216a7.firebasestorage.app",
        messagingSenderId: "1014659160462",
        appId: "1:1014659160462:web:d9bb29344e36ab031bacdf"
        };
        /* ----------------------------------------------------------- */

        // Init vars
        let app, auth, db, currentUser = null;

        // Try Initialize
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    // Update UI Logged In
                    document.getElementById('btn-login').style.display = 'none';
                    const img = document.getElementById('u-img');
                    img.src = user.photoURL; img.style.display = 'block';
                    window.renderCloudHistory(); // Auto load if logged in
                } else {
                    currentUser = null;
                    // Update UI Logged Out
                    document.getElementById('btn-login').style.display = 'block';
                    document.getElementById('u-img').style.display = 'none';
                }
            });

        } catch(e) { console.log("Firebase setup pending (Paste keys in code)"); }

        // --- GLOBAL ACTIONS ---
        window.authLogin = async () => {
            if(!auth) return alert("API Key Firebase belum diisi di kode HTML!");
            const p = new GoogleAuthProvider();
            try { await signInWithPopup(auth, p); } catch(e) { console.error(e); }
        }
        
        window.authLogout = () => { if(auth) signOut(auth); }

        window.saveToHistory = async (fileName, resultData) => {
            // Priority: Cloud if logged in, else LocalStorage
            if(currentUser && db){
                try {
                    await addDoc(collection(db, "lumina_history"), {
                        uid: currentUser.uid,
                        file: fileName,
                        result: resultData,
                        ts: new Date()
                    });
                } catch(e) { console.error("Cloud save err", e); }
            } else {
                let h = JSON.parse(localStorage.getItem('L_HIST')||"[]");
                h.unshift({ file: fileName, result: resultData, ts: new Date() });
                if(h.length>10) h.pop(); // Keep 10 local
                localStorage.setItem('L_HIST', JSON.stringify(h));
            }
        }

        window.renderCloudHistory = async () => {
            if(!currentUser || !db) return;
            document.getElementById('hist-msg').innerText = "Memuat riwayat cloud...";
            document.getElementById('hist-content').innerHTML = "";
            
            const q = query(collection(db, "lumina_history"), where("uid", "==", currentUser.uid), orderBy("ts", "desc"));
            const querySnapshot = await getDocs(q);
            
            if(querySnapshot.empty) {
                document.getElementById('hist-msg').innerText = "Belum ada riwayat Cloud.";
                return;
            }
            
            document.getElementById('hist-msg').style.display = 'none';
            querySnapshot.forEach((doc) => {
                let d = doc.data();
                // Render function shared (see standard script below)
                window.addHistItemUI(d.file, d.result, new Date(d.ts.seconds*1000).toLocaleDateString());
            });
        }
        
        // Expose render local if logged out
        window.renderLocalHistory = () => {
            let h = JSON.parse(localStorage.getItem('L_HIST')||"[]");
            document.getElementById('hist-content').innerHTML = "";
            if(h.length === 0){
                document.getElementById('hist-msg').innerText = "Belum ada riwayat Lokal. Login untuk sync.";
                document.getElementById('hist-msg').style.display='block';
                return;
            }
            document.getElementById('hist-msg').style.display='none';
            h.forEach(x => {
                // Compatibility handling for stored dates
                let d = x.ts ? new Date(x.ts).toLocaleDateString() : "Local";
                window.addHistItemUI(x.file, x.result, d);
            });
        }
        
        // Sync Logic on Open
        window.syncHist = () => {
            if(currentUser) window.renderCloudHistory();
            else window.renderLocalHistory();
        }

    </script>

    <!-- STANDARD LOGIC (Backend interaction) -->
    <script>
        let URL = localStorage.getItem('API_U') || "";
        let MDL = "inst_v1e_plus";
        let FILE = null;
        let CURRENT_HOST = ""; // To reconstruct links if stored as relative paths

        window.onload = () => {
            if(URL){ document.getElementById('api').value = URL; CURRENT_HOST = URL; }
            document.getElementById('f').onchange = (e) => {
                if(e.target.files[0]){
                    FILE = e.target.files[0];
                    document.getElementById('sub').innerText = FILE.name;
                    document.getElementById('ico').className = "fas fa-check";
                    document.querySelector('.av-wrap').classList.add('done');
                }
            }
        };

        // NAVIGATION & MODALS
        function goPortfolio() { 
            // GANTI LINK DI SINI DENGAN URL PORTOFOLIO ANDA
            window.location.href = "https://erga.me/portfolio"; 
        }

        function toggleSet() { 
            let s = document.getElementById('set-drop');
            s.style.display = (s.style.display == 'block') ? 'none' : 'block';
        }
        function openHistory(force) {
            let m = document.getElementById('hist-modal');
            if(force === false) {
                m.style.display = 'none';
            } else {
                m.style.display = 'flex';
                if(window.syncHist) window.syncHist();
            }
        }
        function closeHistory(e) {
            if(e.target.id === 'hist-modal') openHistory(false);
        }

        // SHARED UI HELPER for History Items
        window.addHistItemUI = (fname, data, dateStr) => {
            let htmlLinks = "";
            // Logic for link reconstruction. If stored data is just path, prepend current URL
            let base = window.CURRENT_HOST || localStorage.getItem('API_U');

            Object.keys(data).forEach(k => {
                let link = base ? base + data[k] : "#";
                // Shorten labels
                let label = k.includes('vocal') ? 'Vox' : 'Inst';
                htmlLinks += `<a href="${link}" class="h-link" target="_blank">${label}</a>`;
            });

            let template = `
            <div class="h-item">
                <div class="h-info">
                    <div>${fname}</div>
                    <div>${dateStr}</div>
                </div>
                <div style="display:flex">${htmlLinks}</div>
            </div>`;
            
            document.getElementById('hist-content').innerHTML += template;
        }

        // SETTINGS LOGIC
        function thm(t) {
            document.body.setAttribute('data-theme', (t=='dark'?'dark':'light'));
        }
        function perf(c) {
            document.body.setAttribute('data-perf', (c.checked?'fast':'norm'));
        }
        function sel(m, el) {
            MDL = m;
            document.querySelectorAll('.m-card').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
        }

        async function con(b) {
            let val = document.getElementById('api').value.replace(/\/$/, "");
            if(!val) return;
            b.innerText = "...";
            try {
                let r = await fetch(val + '/ping');
                if(r.ok) {
                    URL = val; CURRENT_HOST = val; localStorage.setItem('API_U', val);
                    b.innerText = "Linked";
                }
            } catch { 
                if(confirm("Buka tab?")) window.open(val); 
                b.innerText = "Link"; 
            }
        }

        // PROCESS
        function run(){
            if(!URL || !FILE) return alert("Koneksi / File kosong!");
            let w = document.getElementById('w-player');
            w.style.display = 'block';
            document.getElementById('w-ic').style.display='none';
            document.getElementById('w-ld').style.display='block';
            document.getElementById('w-mt').innerText = "Uploading...";
            document.getElementById('pl').classList.remove('open');
            document.getElementById('pl').innerHTML = "";

            let fd = new FormData(); fd.append('audio_file', FILE); fd.append('model_name', MDL);
            let x = new XMLHttpRequest();
            x.upload.onprogress = e => { if(e.lengthComputable) document.getElementById('w-pct').innerText=Math.round(e.loaded/e.total*100)+"%"; }
            x.onload = () => { if(x.status==200) mon(JSON.parse(x.responseText).task_id); else {alert('Err'); w.style.display='none';} }
            x.open('POST', URL + '/upload_job'); x.send(fd);
        }

        async function mon(tid) {
            document.getElementById('w-mt').innerText = "Separating...";
            document.getElementById('w-pct').innerText = "";
            let iv = setInterval(async () => {
                try {
                    let r = await fetch(URL + '/check_job/' + tid);
                    let d = await r.json();
                    if(d.message) document.getElementById('w-sb').innerText = d.message;
                    if(d.status === 'done') {
                        clearInterval(iv); done(d.data);
                        // Trigger save
                        if(window.saveToHistory) window.saveToHistory(FILE.name, d.data);
                    }
                    if(d.status === 'error') {
                        clearInterval(iv); alert(d.error); document.getElementById('w-player').style.display='none';
                    }
                } catch {}
            }, 2500);
        }

        function done(dt) {
            document.getElementById('w-ld').style.display='none';
            document.getElementById('w-ic').style.display='block';
            document.getElementById('w-mt').innerText = "Results Ready";
            document.getElementById('w-sb').innerText = "Download stems below";
            
            let html = "";
            Object.keys(dt).forEach(k => {
                let link = URL + dt[k];
                html += `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem; border-bottom:1px solid #222; padding:5px;">
                    <span style="color:#ccc">${k}</span>
                    <a href="${link}" download target="_blank" style="color:#1db954; font-weight:700; text-decoration:none"><i class="fas fa-download"></i> DL</a>
                </div>`;
            });
            let p = document.getElementById('pl');
            p.innerHTML = html;
            p.classList.add('open');
        }
        
        // Close popups on outside click
        window.onclick = function(e) {
            if(!e.target.closest('#set-drop') && !e.target.closest('.btn-set')) document.getElementById('set-drop').style.display='none';
        }
    </script>
</body>
</html>
