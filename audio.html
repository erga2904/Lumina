<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina async</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root{--bg:#09090b;--card:rgba(30,30,35,0.6);--pri:#38bdf8;--txt:#f4f4f5;--mut:#a1a1aa;--bor:rgba(255,255,255,0.08);--ins:#10b981;--voc:#ec4899}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Plus Jakarta Sans',sans-serif;-webkit-tap-highlight-color:transparent;outline:none}
        body{background:var(--bg);color:var(--txt);padding-bottom:120px;background-image:radial-gradient(at 0% 0%,#38bdf810 0,transparent 50%)}
        nav{position:fixed;top:0;width:100%;height:60px;background:rgba(9,9,11,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--bor);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:90}
        
        .main{max-width:800px;margin:80px auto 0;padding:0 15px}
        
        /* BOXES */
        .box-in{display:flex;background:rgba(0,0,0,0.3);padding:5px;border-radius:12px;border:1px solid var(--bor);margin-bottom:10px} /* Reduced margin for link */
        .box-in input{flex:1;background:0 0;border:0;color:#fff;padding:10px;font-family:'JetBrains Mono';font-size:0.85rem}
        .box-in button{background:rgba(255,255,255,0.1);color:#fff;border:0;padding:0 15px;border-radius:8px;font-weight:600;cursor:pointer}
        
        /* COLAB LINK STYLE */
        .clb-lnk{text-align:right;margin-bottom:25px}
        .clb-lnk a{font-family:'JetBrains Mono';font-size:0.75rem;color:var(--pri);text-decoration:none;border-bottom:1px dashed var(--bor);padding-bottom:2px;transition:0.3s}
        .clb-lnk a:hover{border-color:var(--pri);opacity:0.8}

        .up-z{border:2px dashed var(--bor);border-radius:20px;padding:30px;text-align:center;margin-bottom:20px;cursor:pointer;transition:.3s}
        .up-z:active{transform:scale(0.98);background:rgba(255,255,255,0.02)}

        /* GRID SYSTEM */
        .cat{font-size:0.7rem;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:block}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:25px}
        .cd{background:rgba(255,255,255,0.03);border:1px solid var(--bor);padding:15px;border-radius:12px;cursor:pointer;display:flex;gap:12px;align-items:center}
        .cd.active{background:#38bdf815;border-color:var(--pri)}
        .ico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}

        .btn-go{width:100%;padding:16px;background:linear-gradient(135deg,var(--pri),#6366f1);border:0;border-radius:14px;color:#fff;font-weight:700;font-size:1rem;margin-top:20px}

        /* WIDGET & PLAYER STYLE */
        #wdg{position:fixed;bottom:20px;right:20px;width:340px;background:rgba(18,18,22,0.98);backdrop-filter:blur(20px);border:1px solid var(--bor);border-radius:18px;box-shadow:0 15px 60px #000;display:none;flex-direction:column;overflow:hidden;z-index:999;transition:0.3s}
        #wdg.min{width:60px;height:60px;border-radius:30px;justify-content:center;align-items:center;background:#000;border-color:var(--pri);cursor:pointer}
        #wdg.min .cnt{display:none} #wdg.min .hd{padding:0;height:100%;justify-content:center;border:0}
        
        .hd{padding:15px 20px;border-bottom:1px solid var(--bor);display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;font-weight:700;background:rgba(255,255,255,0.02)}
        .cnt{padding:0} 

        /* SIMPLE LOADING AREA */
        #proc-area{padding:40px 20px;text-align:center;display:flex;flex-direction:column;align-items:center}
        .simple-loader {
            width: 45px; height: 45px;
            border: 4px solid rgba(255,255,255,0.1);
            border-bottom-color: var(--pri);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .proc-txt {font-size: 1rem; font-weight: 700; color: #fff; margin-bottom: 5px}
        .proc-sub {font-size: 0.8rem; color: var(--mut); font-family: 'JetBrains Mono'}

        /* PLAYER AREA */
        #player-area{display:none;flex-direction:column}
        .active-track-info{padding:20px;background:linear-gradient(to bottom, rgba(56,189,248,0.08), transparent);border-bottom:1px solid var(--bor)}
        .now-playing-lbl{font-size:0.6rem;color:var(--pri);letter-spacing:2px;font-weight:800;text-transform:uppercase;margin-bottom:5px}
        .track-name-big{font-size:1.1rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:15px;color:#fff}
        
        audio{width:100%;height:32px;filter:invert(1) hue-rotate(180deg);border-radius:4px}
        
        .playlist{max-height:220px;overflow-y:auto;padding:10px 15px}
        .q-item{display:flex;gap:12px;padding:12px;border-radius:12px;margin-bottom:6px;align-items:center;cursor:pointer;transition:0.2s;border:1px solid transparent;background:rgba(255,255,255,0.02)}
        .q-item:hover{background:rgba(255,255,255,0.05)}
        .q-item.playing{background:rgba(56,189,248,0.1);border-color:rgba(56,189,248,0.3)}
        .q-item.playing .q-tit{color:var(--pri)}
        
        .q-icon{width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-size:0.9rem;color:var(--mut)}
        .q-tit{font-size:0.85rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        
        .q-dl{padding:8px 12px;background:rgba(255,255,255,0.1);border-radius:8px;color:#fff;text-decoration:none;font-size:0.8rem;font-weight:700;transition:.2s}
        .q-dl:hover{background:var(--pri);color:#000}
    </style>
</head>
<body>
    <nav>
        <div style="font-family:'JetBrains Mono';font-weight:800;display:flex;align-items:center;gap:10px;font-size:1.1rem">
            <i class="fas fa-layer-group" style="color:var(--pri)"></i> Lumina.async
        </div>
        <div id="stat" style="font-size:0.7rem;color:var(--mut);background:rgba(255,255,255,0.05);padding:5px 12px;border-radius:20px;font-weight:600">OFFLINE</div>
    </nav>

    <div class="main">
        <!-- CONNECT -->
        <div class="box-in">
            <input id="url" placeholder="Cloudflare URL...">
            <button onclick="con(this)">Connect</button>
        </div>

        <!-- NEW: COLAB LINK -->
        <div class="clb-lnk">
            <a href="https://colab.research.google.com/drive/1tw8nJdGokvMY4gMmQ8m3hOG8j0zYK5CV#scrollTo=jswAJ-NK2Aja" target="_blank">
                Open Backend Script <i class="fas fa-external-link-alt" style="margin-left:5px"></i>
            </a>
        </div>
        
        <!-- UPLOAD -->
        <div class="up-z" onclick="document.getElementById('file').click()">
            <input type="file" id="file" hidden accept="audio/*">
            <i class="fas fa-compact-disc" style="font-size:2.8rem;color:var(--mut);transition:0.5s" id="d-icon"></i>
            <div id="fn" style="font-weight:700;margin-top:15px;font-size:1rem;color:var(--txt)">Tap to Upload</div>
        </div>

        <!-- MODEL LIST -->
        <span class="cat">Instrumental Model</span>
        <div class="grid">
            <div class="cd active" onclick="sl('inst_v1e_plus',this)">
                <div class="ico" style="background:#10b98120;color:var(--ins)"><i class="fas fa-guitar"></i></div>
                <div><div style="font-weight:700;font-size:0.85rem">Mel-Band V1E+</div><div style="font-size:0.7rem;color:var(--mut)">Good Quality (Muddy)</div></div>
            </div>
            <div class="cd" onclick="sl('Resurrection-Inst',this)">
                <div class="ico" style="background:#818cf820;color:#818cf8"><i class="fas fa-recycle"></i></div>
                <div><div style="font-weight:700;font-size:0.85rem">Resurrection Inst</div><div style="font-size:0.7rem;color:var(--mut)">Best Quality (Less Muddy)</div></div>
            </div>
        </div>

        <span class="cat">Vocals Models</span>
        <div class="grid">
             <div class="cd" onclick="sl('Resurrection-v',this)">
                 <div class="ico" style="background:#ec489920;color:var(--voc)"><i class="fas fa-microphone-lines"></i></div>
                 <div><div style="font-weight:700;font-size:0.85rem">Resurrection V</div><div style="font-size:0.7rem;color:var(--mut)">Best Vocals</div></div>
             </div>
             <div class="cd" onclick="sl('Kim_Vocal_2',this)">
                 <div class="ico" style="background:#ec489920;color:var(--voc)"><i class="fas fa-bolt"></i></div>
                 <div><div style="font-weight:700;font-size:0.85rem">Kim Vocal 2</div><div style="font-size:0.7rem;color:var(--mut)">Fast MDX</div></div>
             </div>
        </div>

        <button class="btn-go" onclick="run()">PROCESS AUDIO</button>
    </div>

    <!-- WIDGET -->
    <div id="wdg" onclick="expand()">
        <div class="hd">
            <span id="wst">Ready</span>
            <i class="fas fa-minus" style="cursor:pointer;opacity:0.7" onclick="mini(event)"></i>
        </div>
        <div class="cnt">
            
            <!-- SIMPLE LOADER VIEW -->
            <div id="proc-area">
                <span class="simple-loader"></span>
                <div class="proc-txt" id="p-main-txt">Processing</div>
                <div class="proc-sub" id="p-sub-txt">Initializing...</div>
            </div>

            <!-- PLAYER VIEW -->
            <div id="player-area">
                <div class="active-track-info">
                    <div class="now-playing-lbl">NOW PLAYING</div>
                    <div class="track-name-big" id="p-tit">Select a track...</div>
                    <audio id="au" controls autoplay controlsList="nodownload"></audio>
                </div>
                <div class="playlist" id="plist">
                    <!-- ITEMS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let URL=localStorage.getItem('U')||"", MOD='inst_v1e_plus', FIL=null;
        
        let queue = [];
        let currIdx = 0;
        let aud = document.getElementById('au');

        window.onload=()=>{
            if(URL)document.getElementById('url').value=URL;
            document.getElementById('file').onchange=e=>{
                if(e.target.files[0]){
                    FIL=e.target.files[0]; 
                    document.getElementById('fn').innerText=FIL.name; 
                    let ic = document.getElementById('d-icon');
                    ic.style.color="var(--pri)"; ic.classList.add('fa-spin'); ic.style.animationDuration="4s";
                    document.querySelector('.up-z').style.borderColor="var(--pri)";
                }
            }
            aud.addEventListener('ended', () => { if(currIdx < queue.length - 1) playTrack(currIdx + 1); });
        }
        
        function sl(i,e){MOD=i; document.querySelectorAll('.cd').forEach(c=>c.classList.remove('active')); e.classList.add('active')}
        
        async function con(b){
            let u=document.getElementById('url').value.replace(/\/$/,""); if(!u)return;
            b.innerText="..."; try{ let r=await fetch(u+'/ping'); if(r.ok){
                let d=await r.json(); URL=u; localStorage.setItem('U',u); document.getElementById('stat').innerText=`CONNECTED (${d.device})`; document.getElementById('stat').style.color="#10b981"; b.innerText="OK";
            }}catch{if(confirm("Failed. Open Tab?"))window.open(u,'_blank'); b.innerText="Retry"}
        }

        function mini(e){e.stopPropagation(); document.getElementById('wdg').classList.add('min'); document.getElementById('wst').innerHTML="<i class='fas fa-record-vinyl fa-spin'></i>"}
        function expand(){
            if(document.getElementById('wdg').classList.contains('min')){
                document.getElementById('wdg').classList.remove('min'); 
                // Restore status title
                let status = document.getElementById('proc-area').style.display !== 'none' ? "Processing..." : "Player";
                document.getElementById('wst').innerText = status;
            }
        }

        function run(){
            if(!URL||!FIL)return alert("Link/File?");
            let w=document.getElementById('wdg'); w.style.display='flex'; w.classList.remove('min');
            
            // Set UI State: Processing
            document.getElementById('proc-area').style.display='flex'; // Flex untuk centering
            document.getElementById('player-area').style.display='none';
            document.getElementById('wst').innerText="Uploading...";
            document.getElementById('p-main-txt').innerText="Uploading Audio";
            document.getElementById('p-sub-txt').innerText="Please wait...";
            
            aud.pause();

            let fd=new FormData(); fd.append('audio_file',FIL); fd.append('model_name',MOD);
            let x=new XMLHttpRequest();
            x.upload.onprogress=e=>{if(e.lengthComputable){
                let p=Math.round(e.loaded/e.total*100); 
                document.getElementById('p-sub-txt').innerText=`Uploaded: ${p}%`;
            }}
            x.onload=()=>{if(x.status==200)trac(JSON.parse(x.responseText).task_id); else{alert("Err");w.style.display='none'}}
            x.open('POST',URL+'/upload_job'); x.send(fd);
        }

        async function trac(id){
            document.getElementById('wst').innerText="Processing";
            document.getElementById('p-main-txt').innerText="AI Separating";
            document.getElementById('p-sub-txt').innerText="Starting Engine...";

            let iv=setInterval(async()=>{
                try{
                    let r=await fetch(URL+'/check_job/'+id); let d=await r.json();
                    
                    if(d.message) document.getElementById('p-sub-txt').innerText = d.message; 
                    if(d.progress) document.getElementById('p-sub-txt').innerText = `Running... (${d.progress}%)`;

                    if(d.status==='done'){
                        clearInterval(iv); initPlayer(d.data);
                    }
                    if(d.status==='error'){clearInterval(iv); alert(d.error); document.getElementById('wdg').style.display='none'}
                }catch{}
            },2500);
        }

        function initPlayer(data){
            document.getElementById('wst').innerText="Result Player";
            document.getElementById('proc-area').style.display='none';
            document.getElementById('player-area').style.display='flex';
            
            queue = [];
            let pl = document.getElementById('plist'); pl.innerHTML = "";
            let sortedKeys = Object.keys(data).sort((a,b) => a.includes('vocal') ? -1 : 1);
            
            sortedKeys.forEach((key, index) => {
                let url = URL + data[key];
                queue.push({ name: key, url: url });
                let icon = key.toLowerCase().includes('ocal') ? 'fa-microphone' : 'fa-music';
                let col = key.toLowerCase().includes('ocal') ? 'var(--voc)' : 'var(--ins)';
                
                pl.innerHTML += `
                    <div class="q-item" id="tr-${index}" onclick="playTrack(${index})">
                        <div class="q-icon" style="color:${col}"><i class="fas ${icon}"></i></div>
                        <div class="q-tit">${key}</div>
                        <a href="${url}" class="q-dl" download target="_blank" onclick="event.stopPropagation()">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                `;
            });
            if(queue.length > 0) playTrack(0);
        }
        
        function playTrack(index){
            currIdx = index;
            document.querySelectorAll('.q-item').forEach(el => el.classList.remove('playing'));
            let activeEl = document.getElementById(`tr-${index}`);
            if(activeEl) activeEl.classList.add('playing');
            
            document.getElementById('p-tit').innerText = queue[index].name;
            aud.src = queue[index].url;
            aud.play().catch(e => console.log("Auto-play blocked"));
        }
    </script>
</body>
</html>
