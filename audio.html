<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina V50 | Animated</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            /* THEME VARIABLES */
            --primary: #fb923c; 
            --bg-grad: linear-gradient(135deg, #fddbb7 0%, #f7ebd9 50%, #dcfce7 100%);
            --txt-prim: #1f1f1f; --txt-sec: #6b7280;
            --card-bg: #ffffff;
            --nav-bg: rgba(253, 252, 246, 0.9); --glass: blur(20px);
            --acc-btn: #f5f5f4; --acc-act: #18181b; 
            --btn-start: #ffe4cc; --btn-text: #9c4221;
            
            --warn-bg: #fef9c3; --warn-txt: #854d0e;
            --gpu-bg: #dcfce7; --gpu-txt: #166534;
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            --txt-prim: #ffffff; --txt-sec: #a1a1aa;
            --card-bg: #121212; --nav-bg: rgba(24, 24, 27, 0.9);
            --acc-btn: #27272a; --acc-act: #38bdf8;
            --primary: #38bdf8;
            --btn-start: #3f3f46; --btn-text: #fff;
        }

        [data-perf="fast"] { --glass: none; --nav-bg: var(--card-bg); }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body {
            background: var(--bg-grad); background-attachment: fixed; color: var(--txt-prim);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding-bottom: 120px; 
            transition: background 0.5s ease;
        }

        /* --- KEYFRAMES ANIMATION --- */
        @keyframes fadeInDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes popSpring { 0% { transform:scale(0.9); opacity:0; } 50% { transform:scale(1.02); opacity:1; } 100% { transform:scale(1); } }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* --- NAVBAR --- */
        nav {
            margin-top: 20px; background: var(--nav-bg); backdrop-filter: var(--glass);
            padding: 10px 15px 10px 25px; border-radius: 50px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 8px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.4);
            z-index: 100; min-width: 400px; max-width: 95%; gap: 10px;
            
            /* ANIMATION */
            animation: fadeInDown 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .nav-brand { 
            font-weight: 700; font-size: 1.1rem; cursor: pointer; white-space: nowrap; 
            display: flex; align-items: center; gap: 8px; color: var(--txt-prim); 
            transition: 0.2s;
        }
        .nav-brand:hover { transform: translateX(-3px); }

        .nav-mid { display:flex; gap:15px; flex:1; justify-content:center; }
        .nav-link { 
            cursor:pointer; font-weight:600; font-size:0.9rem; color:var(--txt-sec); 
            padding:6px 12px; border-radius:15px; transition:0.2s;
        }
        .nav-link.active, .nav-link:hover { color:var(--txt-prim); background:rgba(0,0,0,0.05); }
        
        .nav-user { display: flex; gap: 8px; align-items: center; }
        
        .btn-auth { 
            background: #000; color: #fff; padding: 8px 16px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: 700; cursor: pointer; border: none; white-space: nowrap; 
            transition: all 0.2s;
        }
        .btn-auth:active { transform: scale(0.95); }
        
        .user-pic { width: 34px; height: 34px; border-radius: 50%; background: #ccc; display: none; cursor: pointer; border: 2px solid #fff; object-fit: cover; transition: 0.2s; }
        .user-pic:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.1); }

        .btn-cog { 
            width: 34px; height: 34px; border-radius: 50%; border:none; background:transparent;
            color: var(--txt-prim); cursor: pointer; transition: 0.3s; font-size: 1.1rem;
            display: flex !important; align-items: center; justify-content: center;
        }
        .btn-cog:hover { transform: rotate(90deg); background: rgba(0,0,0,0.05); }

        @media (max-width: 600px) {
            nav { width: 92%; min-width: unset; margin-top: 15px; padding: 10px; }
            .nav-brand span { display:none }
            .nav-link { font-size: 0.8rem; padding: 4px 8px; }
        }

        /* --- HERO & MAIN CARD (Spacious & Animated) --- */
        .hero-card {
            margin-top: 110px; /* Spacer from Header */
            background: var(--card-bg); width: 92%; max-width: 500px;
            border-radius: 40px; padding: 50px 30px; text-align: center; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.08);
            
            /* ANIMATION */
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.1s backwards;
        }
        
        .av-wrap {
            width: 90px; height: 90px; margin: 0 auto 25px; background: var(--primary); color: #fff;
            border-radius: 50%; font-size: 2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 5px solid #fff; box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .av-wrap:hover { transform: scale(1.1) rotate(5deg); }
        .av-wrap:active { transform: scale(0.95); }
        .av-wrap.ok { background: #10b981; }

        h1 { margin-bottom: 8px; letter-spacing: -0.5px; animation: fadeInUp 0.8s ease 0.2s backwards;}
        .st-sub { color:var(--txt-sec); margin-bottom: 35px; font-size:0.95rem; animation: fadeInUp 0.8s ease 0.3s backwards;}

        .inp-pill { 
            background: var(--acc-btn); border-radius: 18px; padding: 8px; 
            display: flex; margin-bottom: 25px; transition:0.3s;
        }
        .inp-pill:focus-within { transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.05); background: var(--card-bg); border: 1px solid var(--primary); }
        
        .inp-pill input { flex: 1; border: 0; background: transparent; padding: 0 15px; color: var(--txt-prim); font-weight: 600; font-size: 0.95rem;}
        .inp-pill button { 
            background: var(--card-bg); color: var(--txt-prim); border: 0; padding: 12px 24px; border-radius: 14px; 
            font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .inp-pill button:active { transform: scale(0.95); }

        #conn-info { margin-bottom: 25px; display:none; flex-direction:column; align-items:center; gap:8px }
        .st-badge { font-size: 0.75rem; padding: 6px 14px; border-radius: 20px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .st-badge.gpu { background: var(--gpu-bg); color: var(--gpu-txt); }
        .st-badge.cpu { background: var(--warn-bg); color: var(--warn-txt); }
        
        .lnk-colab { 
            font-size: 0.8rem; font-weight:600; color: #a1a1aa; text-decoration: none; 
            border-bottom: 1px dashed #d1d5db; margin-bottom: 35px; display: inline-block; transition:0.2s; padding-bottom:2px
        }
        .lnk-colab:hover { color: var(--primary); border-color: var(--primary); }

        /* MODELS */
        .sec-lbl { 
            text-align: left; font-size: 0.75rem; font-weight: 800; color: #a1a1aa; 
            letter-spacing: 1.5px; margin-bottom: 15px; margin-top: 5px;
        }
        .grid-mdl { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 35px }
        
        .m-card {
            background: var(--acc-btn); border-radius: 24px; padding: 20px; text-align: left;
            display: flex; gap: 15px; align-items: center; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border: 2px solid transparent;
        }
        .m-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff; }
        .m-card.active { background: var(--acc-act); border-color: var(--acc-act); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .m-card.active * { color: #fff !important; }
        .m-card.active .ibox { background: #fff !important; color: #000 !important; }
        
        .ibox { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; background: #fff; color: #333; transition: 0.3s; }
        .mc-t { font-size: 0.85rem; font-weight: 700; color: var(--txt-prim); margin-bottom: 3px; }
        .mc-s { font-size: 0.7rem; color: var(--txt-sec); }

        .btn-go {
            width: 100%; background: var(--primary); color: #fff; border: 0; padding: 22px; 
            border-radius: 24px; font-size: 1rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px; transition:0.3s;
            box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1);
        }
        .btn-go:hover { transform: translateY(-3px); box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15); filter:brightness(1.05); }
        .btn-go:active { transform: scale(0.98); }

        /* --- MODALS (ANIMATED) --- */
        #set-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 300; display: none; align-items: center; justify-content: center; opacity:0; transition:opacity 0.3s }
        
        .set-card { 
            background: #232732; color: #fff; width: 360px; padding: 30px; border-radius: 32px; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.6); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Modal Visible State handled by JS class or inline style flow, here we rely on Animation Keyframe 'popSpring' */
        .pop-active { animation: popSpring 0.4s forwards; }

        .set-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; }
        .set-tit { font-size: 1.5rem; font-weight: 800; }
        .set-cls { background:transparent; border:none; color:#9ca3af; font-size:1.5rem; cursor:pointer; }
        .set-lbl { font-size: 0.9rem; color: #9ca3af; margin-bottom: 12px; font-weight: 600;}
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 30px; }
        .c-btn { width: 100%; aspect-ratio: 1; border-radius: 14px; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
        .c-btn:hover { transform: scale(1.1); }
        .c-btn.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .bg-blue { background: #38bdf8; } .bg-purple { background: #c084fc; } .bg-orange { background: #fb923c; } 
        .bg-green { background: #4ade80; } .bg-slate { background: #94a3b8; }
        .lang-row { display:flex; gap:10px; margin-bottom: 30px; }
        .l-btn { flex:1; padding: 14px; border-radius: 16px; font-weight:800; background: transparent; border: 1px solid #475569; color: #fff; cursor: pointer; transition:0.2s }
        .l-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .perf-box { width: 100%; padding: 16px; border-radius: 18px; background: #2f3542; border: 1px solid #4b5563; color: #fff; font-weight: 700; cursor: pointer; display: flex; justify-content: center; gap: 10px; transition: 0.2s; }
        .perf-box.on { border-color: var(--primary); background: #1e293b; color: var(--primary); }

        /* WIDGET PLAYER (Dark Glass) */
        #wdg {
            position: fixed; bottom: 30px; width: 92%; max-width: 420px;
            background: #111; color: #fff; border-radius: 28px; padding: 25px;
            display: none; flex-direction: column; box-shadow: 0 30px 80px rgba(0,0,0,0.6); 
            z-index: 200; border: 1px solid #333;
            animation: slideUpWidget 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        @keyframes slideUpWidget { from { transform:translateY(100px); opacity:0; } to { transform:translateY(0); opacity:1; } }

        .w-top { display: flex; gap: 20px; margin-bottom: 25px; align-items: center; }
        .w-art { width: 64px; height: 64px; border-radius: 16px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; }
        .w-tit { font-weight: 800; font-size: 1.1rem; margin-bottom: 2px; } .w-sub { font-size: 0.8rem; color: #888; font-weight:500 }
        
        .w-seek { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #333; cursor: pointer; }
        .w-seek::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #fff; transition:0.1s}
        .w-seek::-webkit-slider-thumb:hover { transform:scale(1.2); }
        
        .w-ctrls { display: flex; justify-content: center; gap: 30px; margin-top: 15px; align-items: center; }
        .wc-btn { background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; opacity: 0.7; transition:0.2s }
        .wc-btn:hover { opacity: 1; transform:scale(1.1); }
        .wc-main { width: 60px; height: 60px; background: #fff; color: #000; border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; transition:0.2s; box-shadow: 0 0 20px rgba(255,255,255,0.1)}
        .wc-main:hover { transform:scale(1.05); box-shadow: 0 0 30px rgba(255,255,255,0.3); }

        .w-queue { border-top: 1px solid #333; margin-top: 15px; padding-top: 10px; max-height: 180px; overflow-y: auto; display: none; }
        .q-row { padding: 12px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; gap: 15px; color:#ccc; transition:0.2s }
        .q-row:hover { background: #222; color:#fff } .q-row.active { background: #333; color: var(--primary); }
        .w-ld { width: 24px; height: 24px; border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin {to{transform:rotate(360deg)}} audio { display:none }

        /* OTHER MODALS */
        .ovl { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:300; display:none; justify-content:center; align-items:center }
        .pop { background:var(--card-bg); width:340px; padding:25px; border-radius:24px; box-shadow:0 30px 70px rgba(0,0,0,0.2); animation: popSpring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) }
        .pop-h { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; }
        .ph-t { font-weight:800; font-size:1rem; color:var(--txt-prim) }
        .ph-c { background:none; border:none; font-size:1.5rem; cursor:pointer; color:#aaa; line-height: 1; }
        .h-item { padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: left; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-brand" onclick="window.location.href='https://lumina-omega-five.vercel.app/'">
            <i class="fas fa-chevron-left"></i> <span>Lumina</span>
        </div>
        <div class="nav-mid">
            <span class="nav-link active">Studio</span>
            <span class="nav-link" onclick="openHist()">History</span>
        </div>
        <div class="nav-user">
            <img src="" id="u-img" class="user-pic" onclick="openProfile()">
            <button id="btn-login" class="btn-auth" onclick="authLogin()">Login</button>
            <button class="btn-cog" onclick="toggleSet(true)"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <!-- SETTINGS -->
    <div id="set-modal" class="ovl" style="transition: opacity 0.3s;">
        <div class="set-card" onclick="event.stopPropagation()">
            <div class="set-head">
                <span class="set-tit">Settings</span>
                <button class="set-cls" onclick="toggleSet(false)">&times;</button>
            </div>
            
            <div class="set-lbl">Accent Color</div>
            <div class="color-grid">
                <div class="c-btn bg-blue" onclick="setAccent('#38bdf8', this)"></div>
                <div class="c-btn bg-purple" onclick="setAccent('#c084fc', this)"></div>
                <div class="c-btn bg-orange active" onclick="setAccent('#fb923c', this)"></div>
                <div class="c-btn bg-green" onclick="setAccent('#4ade80', this)"></div>
                <div class="c-btn bg-slate" onclick="setAccent('#94a3b8', this)"></div>
            </div>

            <div class="set-lbl">Mode</div>
            <div class="lang-row">
                <button class="l-btn active" onclick="thm('')">Light</button>
                <button class="l-btn" onclick="thm('dark')">Dark</button>
            </div>

            <div class="perf-box" id="perf-btn" onclick="tPerf()">
                <i class="fas fa-gauge-high"></i> Performance Mode
            </div>
        </div>
    </div>

    <!-- PROFILE -->
    <div id="user-modal" class="ovl" onclick="closeProfile(event)">
        <div class="pop">
            <img src="" id="p-img" style="width:85px;height:85px;border-radius:50%;margin-bottom:15px;object-fit:cover;border:3px solid var(--primary)">
            <h3 id="p-name" style="margin:0;font-size:1.2rem;color:var(--txt-prim)">User</h3>
            <p id="p-email" style="margin:5px 0 25px;font-size:0.8rem;color:var(--txt-sec)">email@ex.com</p>
            <button onclick="authLogout()" style="width:100%;padding:14px;background:#fee2e2;color:#ef4444;border:none;border-radius:14px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:0.2s">Sign Out</button>
        </div>
    </div>

    <!-- HISTORY -->
    <div id="hist-modal" class="ovl" onclick="closeHist(event)">
        <div class="pop" style="max-width:400px" onclick="event.stopPropagation()">
            <div class="pop-h">
                <span class="ph-t" style="font-size:1.1rem;font-weight:800;color:var(--txt-prim)">Separation History</span>
                <button class="ph-c" onclick="openHist(false)">&times;</button>
            </div>
            <div id="h-msg" style="text-align:center; padding:30px; color:var(--txt-sec); font-size:0.9rem">Loading...</div>
            <div id="h-lst" style="max-height:350px;overflow-y:auto;text-align:left"></div>
        </div>
    </div>

    <div class="hero-card">
        <div class="av-wrap" onclick="document.getElementById('f').click()">
            <input type="file" id="f" hidden accept="audio/*">
            <i class="fas fa-cloud-upload-alt" id="ico"></i>
        </div>
        <h1 style="margin:5px 0">Studio</h1>
        <div style="color:var(--txt-sec);margin-bottom:25px;font-size:0.95rem; font-weight:500" id="st-sub">Tap icon to select file</div>

        <div class="inp-pill">
            <input id="api" placeholder="Cloudflare Link...">
            <button onclick="cn(this)">Connect</button>
        </div>

        <div id="conn-info" style="display:none;flex-direction:column;align-items:center;gap:10px;margin-bottom:30px">
            <div id="st-bdg" class="st-badge"></div>
            <div id="cpu-alert" style="font-size:0.8rem;background:#fef9c3;color:#854d0e;padding:10px 15px;border-radius:12px">⚠️ CPU Mode (Slow Process)</div>
        </div>

        <a href="https://colab.research.google.com/drive/1tw8nJdGokvMY4gMmQ8m3hOG8j0zYK5CV#scrollTo=jswAJ-NK2Aja" target="_blank" class="lnk-colab">Script Colab &nearr;</a>

        <div class="sec-lbl">INSTRUMENTAL</div>
        <div class="grid-mdl">
            <div class="m-card active" onclick="sel('inst_v1e_plus',this)">
                <div class="ibox"><i class="fas fa-wave-square" style="color:#10b981"></i></div>
                <div><div class="mc-t">MelBand V1E+</div><div class="mc-s">High Quality</div></div>
            </div>
            <div class="m-card" onclick="sel('Resurrection-Inst',this)">
                <div class="ibox"><i class="fas fa-star" style="color:#6366f1"></i></div>
                <div><div class="mc-t">Resurrec Inst</div><div class="mc-s">Classic ViperX</div></div>
            </div>
        </div>
        <div class="sec-lbl">VOCALS</div>
        <div class="grid-mdl">
             <div class="m-card" onclick="sel('Resurrection-v',this)">
                 <div class="ibox"><i class="fas fa-microphone" style="color:#ec4899"></i></div>
                 <div><div class="mc-t">Resurrec Voc</div><div class="mc-s">Detail Voice</div></div>
             </div>
             <div class="m-card" onclick="sel('Kim_Vocal_2',this)">
                 <div class="ibox"><i class="fas fa-bolt" style="color:#f59e0b"></i></div>
                 <div><div class="mc-t">Kim Vocal 2</div><div class="mc-s">Fast Process</div></div>
             </div>
        </div>

        <button class="btn-go" onclick="run()">START PROCESS</button>
    </div>

    <!-- WIDGET PLAYER -->
    <div id="wdg">
        <div class="w-top">
            <div class="w-art"><i class="fas fa-music" id="w-ic"></i><div class="w-ld" id="w-l" style="display:none"></div></div>
            <div class="w-meta">
                <div class="w-tit" id="w-t">Waiting...</div>
                <div class="w-sub" id="w-s">Upload Audio</div>
            </div>
            <i class="fas fa-chevron-down" style="cursor:pointer;color:#aaa" onclick="document.getElementById('q-list').classList.toggle('open')"></i>
        </div>
        
        <div id="w-ctr-area" style="display:none">
            <div style="margin-bottom:10px">
                <input type="range" class="w-seek" id="seek" value="0" step="0.1" oninput="seekAud(this.value)">
                <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:#777;margin-top:5px">
                    <span id="t-cur">00:00</span><span id="t-dur">00:00</span>
                </div>
            </div>
            <div class="w-ctrls">
                <button class="wc-btn" onclick="prevT()"><i class="fas fa-backward"></i></button>
                <button class="wc-main" onclick="togglePlay()"><i class="fas fa-play" id="btn-p"></i></button>
                <button class="wc-btn" onclick="nextT()"><i class="fas fa-forward"></i></button>
            </div>
        </div>
        <div class="w-queue" id="q-list"></div>
    </div>
    
    <audio id="au" ontimeupdate="updProg()"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ----- GANTI CONFIG FIREBASE DI SINI -----
        const firebaseConfig = {
        apiKey: "AIzaSyDkSwr7n2niyN5MFzr6LMOIv-4Vpqa9LlY",
        authDomain: "studio-7547085914-216a7.firebaseapp.com",
        projectId: "studio-7547085914-216a7",
        storageBucket: "studio-7547085914-216a7.firebasestorage.app",
        messagingSenderId: "1014659160462",
        appId: "1:1014659160462:web:d9bb29344e36ab031bacdf"
        };

        try { 
            const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
            onAuthStateChanged(auth, u=>{ 
                if(u){ document.getElementById('u-img').src=u.photoURL; document.getElementById('u-img').style.display='block'; document.getElementById('btn-login').style.display='none'; 
                       document.getElementById('p-img').src=u.photoURL; document.getElementById('p-name').innerText=u.displayName; document.getElementById('p-email').innerText=u.email; 
                       window.refreshCloud(u, db); 
                } else { document.getElementById('btn-login').style.display='block'; document.getElementById('u-img').style.display='none'; }
                window.curU = u; window.db = db;
            });
            window.authLogin=async()=>{await signInWithPopup(auth,new GoogleAuthProvider())}; window.authLogout=()=>signOut(auth);
            
            // Logic Bridge
            window.saveHist = async (f, d) => {
                if(window.curU && window.db) { try { await addDoc(collection(window.db, "history"), { uid:window.curU.uid, f:f, d:d, ts:Date.now() }); window.refreshCloud(window.curU, window.db); } catch(e){} }
                let h=JSON.parse(localStorage.getItem('L_HIST')||"[]"); h.unshift({f:f, d:d, ts: Date.now() }); localStorage.setItem('L_HIST', JSON.stringify(h));
            }
            window.refreshCloud = async(u, db) => {
                const elList=document.getElementById('h-lst'), elMsg=document.getElementById('h-msg');
                elMsg.innerText="Syncing..."; const q=query(collection(db,"history"), where("uid","==",u.uid)); const s=await getDocs(q);
                if(s.empty) return window.showLocal();
                let a=[]; s.forEach(d=>a.push(d.data())); a.sort((x,y)=>y.ts-x.ts);
                elList.innerHTML=""; elMsg.style.display='none';
                a.forEach(d=>window.renderHItem(d.f, d.d, new Date(d.ts).toLocaleDateString()));
            }
        } catch(e){}
    </script>

    <script>
        let BACKEND = localStorage.getItem('API')||"", M='inst_v1e_plus', F=null;
        let Q=[], IDX=0, AU=document.getElementById('au');

        function cleanName(raw) {
            let s = raw; if(s.includes('_')) s = s.substring(s.indexOf('_')+1); 
            s = s.replace(/(_?model_?|mel_band|roformer|bs_roformer|kim_vocal).*/gi, ""); s = s.replace(/\.(mp3|wav|flac)$/i, "");
            return s.replace(/_/g, " ");
        }

        window.onload=()=>{
            if(BACKEND) document.getElementById('api').value = BACKEND;
            let c=localStorage.getItem('L_ACCENT'); if(c) setAccent(c);
            let t=localStorage.getItem('THEME'); if(t) thm(t);
            document.getElementById('f').onchange=e=>{
                if(e.target.files[0]){ F=e.target.files[0]; document.getElementById('st-sub').innerText=F.name; document.getElementById('ico').className="fas fa-check"; document.querySelector('.av-wrap').classList.add('ok');}
            }
            AU.onended = nextT;
        }

        /* --- VISUAL INTERACTION LOGIC (Smooth) --- */
        function toggleSet(x){ 
            let el = document.getElementById('set-modal');
            if(x===true) { el.style.display = 'flex'; setTimeout(()=>el.style.opacity=1, 10); } 
            else { el.style.opacity=0; setTimeout(()=>el.style.display='none', 300); }
        }
        function closeSet(e){ if(e.target.id=='set-modal') toggleSet(false); }
        function setAccent(col, el){ document.documentElement.style.setProperty('--primary', col); localStorage.setItem('L_ACCENT', col); if(el){ document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }}
        function tPerf(){ let p=document.body.getAttribute('data-perf'); document.body.setAttribute('data-perf', p=='fast'?'':'fast'); document.getElementById('perf-btn').classList.toggle('on'); }
        function thm(x){ document.body.setAttribute('data-theme', x); localStorage.setItem('THEME', x); }
        
        function openProfile() { 
            document.getElementById('user-modal').style.display='flex';
        }
        function closeProfile(e){ 
            if(e.target.id === 'user-modal' || e === false) document.getElementById('user-modal').style.display='none';
        }
        
        function openHist(x) { 
            let h = document.getElementById('hist-modal');
            h.style.display=(x===false?'none':'flex'); 
            if(x!==false) { 
                if(window.curU && window.refreshCloud) window.refreshCloud(window.curU, window.db); 
                else window.showLocal(); 
            }
        }
        function closeHist(e){ if(e.target.id=='hist-modal') openHist(false); }

        window.showLocal = () => {
            let h = JSON.parse(localStorage.getItem('L_HIST')||"[]"), el = document.getElementById('h-lst'), msg = document.getElementById('h-msg');
            el.innerHTML=""; if(h.length==0) msg.innerText="History Empty.";
            else { msg.style.display='none'; h.forEach(x => window.renderHItem(x.f, x.d, new Date(x.ts).toLocaleDateString())); }
        }
        window.renderHItem = (f, d, t) => {
            let b = localStorage.getItem('API') || ""; let lks = ""; 
            Object.keys(d).forEach(k=>{ let l = b + d[k]; lks += `<a href="${l}" target="_blank" style="margin-left:5px;font-size:0.7rem;color:var(--primary);text-decoration:none;background:rgba(0,0,0,0.05);padding:3px 8px;border-radius:6px;font-weight:700">${k}</a>` });
            document.getElementById('h-lst').innerHTML+=`<div class="h-item"><div style="display:flex;justify-content:space-between"><span style="font-weight:700;font-size:0.85rem;color:var(--txt-prim)">${f}</span><span style="font-size:0.6rem;color:var(--txt-sec)">${t}</span></div><div style="margin-top:5px">${lks}</div></div>`;
        }

        async function cn(b){
            let v=document.getElementById('api').value.replace(/\/$/,""); b.innerText="...";
            try{let r=await fetch(v+'/ping'); if(r.ok){ let d=await r.json(); BACKEND=v; localStorage.setItem('API',v); b.innerText="OK"; 
                document.getElementById('conn-info').style.display='flex';
                document.getElementById('st-bdg').className = d.device=='GPU'?'st-badge gpu':'st-badge cpu';
                document.getElementById('st-bdg').innerHTML = d.device=='GPU'?'⚡ GPU Active':'⚠️ CPU Mode';
                document.getElementById('cpu-alert').style.display= d.device=='GPU'?'none':'block';
            }}catch{if(confirm("Tab?"))window.open(v);b.innerText="Link";}
        }

        function sel(m,e){ M=m; document.querySelectorAll('.m-card').forEach(x=>x.classList.remove('active')); e.classList.add('active'); }
        function run(){
            if(!BACKEND||!F)return alert("Input?");
            document.getElementById('wdg').style.display='flex'; document.getElementById('w-l').style.display='block'; document.getElementById('w-ic').style.display='none'; document.getElementById('w-ctr-area').style.display='none'; document.getElementById('q-list').innerHTML=""; document.getElementById('w-t').innerText = "Uploading..."; document.getElementById('w-s').innerText = F.name;
            let fd=new FormData(); fd.append('audio_file',F); fd.append('model_name',M);
            let x=new XMLHttpRequest(); x.onload=()=>{ if(x.status==200) mon(JSON.parse(x.responseText).task_id); }; x.open('POST', BACKEND+'/upload_job'); x.send(fd);
        }

        async function mon(id){
            document.getElementById('w-t').innerText = "Processing...";
            let iv=setInterval(async()=>{
                try{
                    let r=await fetch(BACKEND+'/check_job/'+id); let d=await r.json();
                    if(d.message) document.getElementById('w-s').innerText = d.message;
                    if(d.status=='done'){ clearInterval(iv); done(d.data); if(window.saveHist) window.saveHist(F.name, d.data); }
                }catch{}
            },2000);
        }

        function done(dt){
            document.getElementById('w-l').style.display='none'; document.getElementById('w-ic').style.display='block'; document.getElementById('w-ctr-area').style.display='block';
            Q=[]; let keys = Object.keys(dt).sort((a,b)=> a.includes('vocal')?-1:1); let qH = "";
            keys.forEach((k, i)=>{
                let url = BACKEND + dt[k]; let type = k.toLowerCase().includes('vocal') ? 'Vocal' : 'Instrumental'; let dn = cleanName(k) || type; 
                Q.push({t:dn, u:url, type:type});
                qH += `<div class="q-row" id="qt-${i}" onclick="playQ(${i})"><div class="q-icon"><i class="fas fa-music"></i></div><div class="q-nm">${dn}</div><a href="${url}" download class="q-dl" onclick="event.stopPropagation()"><i class="fas fa-download"></i></a></div>`;
            });
            document.getElementById('q-list').innerHTML=qH; document.getElementById('q-list').classList.add('open'); playQ(0);
        }

        function playQ(i){
            IDX=i; document.querySelectorAll('.q-row').forEach(e=>e.classList.remove('active')); document.getElementById('qt-'+i).classList.add('active');
            document.getElementById('w-t').innerText = Q[i].t; document.getElementById('w-s').innerText = "Lumina • " + Q[i].type;
            AU.src = Q[i].u; togglePlay(true);
        }

        function togglePlay(f){ if(f===true||AU.paused){AU.play(); document.getElementById('btn-p').className = 'fas fa-pause';} else {AU.pause(); document.getElementById('btn-p').className = 'fas fa-play';}}
        function prevT(){ if(IDX>0) playQ(IDX-1); } function nextT(){ if(IDX<Q.length-1) playQ(IDX+1); }
        function updProg(){ document.getElementById('seek').value = (AU.currentTime / AU.duration) * 100 || 0; document.getElementById('t-cur').innerText = fmt(AU.currentTime); document.getElementById('t-dur').innerText = fmt(AU.duration); }
        function seekAud(v){ AU.currentTime = (v / 100) * AU.duration; }
        function fmt(s){ if(!s) return "00:00"; let m=Math.floor(s/60), sc=Math.floor(s%60); return (m<10?'0'+m:m)+":"+(sc<10?'0'+sc:sc); }
    </script>
</body>
</html>
